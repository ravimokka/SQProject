{"ast":null,"code":"/**\n* Copyright 2012-2019, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar Lib = require('../lib');\n\nvar EventEmitter = require('events').EventEmitter;\n\nvar helpers = require('./helpers');\n\nfunction svgToImg(opts) {\n  var ev = opts.emitter || new EventEmitter();\n  var promise = new Promise(function (resolve, reject) {\n    var Image = window.Image;\n    var svg = opts.svg;\n    var format = opts.format || 'png'; // IE only support svg\n\n    if (Lib.isIE() && format !== 'svg') {\n      var ieSvgError = new Error(helpers.MSG_IE_BAD_FORMAT);\n      reject(ieSvgError); // eventually remove the ev\n      //  in favor of promises\n\n      if (!opts.promise) {\n        return ev.emit('error', ieSvgError);\n      } else {\n        return promise;\n      }\n    }\n\n    var canvas = opts.canvas;\n    var scale = opts.scale || 1;\n    var w0 = opts.width || 300;\n    var h0 = opts.height || 150;\n    var w1 = scale * w0;\n    var h1 = scale * h0;\n    var ctx = canvas.getContext('2d');\n    var img = new Image();\n    var svgBlob, url;\n\n    if (format === 'svg' || Lib.isIE9orBelow() || Lib.isSafari()) {\n      url = helpers.encodeSVG(svg);\n    } else {\n      svgBlob = helpers.createBlob(svg, 'svg');\n      url = helpers.createObjectURL(svgBlob);\n    }\n\n    canvas.width = w1;\n    canvas.height = h1;\n\n    img.onload = function () {\n      var imgData;\n      svgBlob = null;\n      helpers.revokeObjectURL(url); // don't need to draw to canvas if svg\n      //  save some time and also avoid failure on IE\n\n      if (format !== 'svg') {\n        ctx.drawImage(img, 0, 0, w1, h1);\n      }\n\n      switch (format) {\n        case 'jpeg':\n          imgData = canvas.toDataURL('image/jpeg');\n          break;\n\n        case 'png':\n          imgData = canvas.toDataURL('image/png');\n          break;\n\n        case 'webp':\n          imgData = canvas.toDataURL('image/webp');\n          break;\n\n        case 'svg':\n          imgData = url;\n          break;\n\n        default:\n          var errorMsg = 'Image format is not jpeg, png, svg or webp.';\n          reject(new Error(errorMsg)); // eventually remove the ev\n          //  in favor of promises\n\n          if (!opts.promise) {\n            return ev.emit('error', errorMsg);\n          }\n\n      }\n\n      resolve(imgData); // eventually remove the ev\n      //  in favor of promises\n\n      if (!opts.promise) {\n        ev.emit('success', imgData);\n      }\n    };\n\n    img.onerror = function (err) {\n      svgBlob = null;\n      helpers.revokeObjectURL(url);\n      reject(err); // eventually remove the ev\n      //  in favor of promises\n\n      if (!opts.promise) {\n        return ev.emit('error', err);\n      }\n    };\n\n    img.src = url;\n  }); // temporary for backward compatibility\n  //  move to only Promise in 2.0.0\n  //  and eliminate the EventEmitter\n\n  if (opts.promise) {\n    return promise;\n  }\n\n  return ev;\n}\n\nmodule.exports = svgToImg;","map":null,"metadata":{},"sourceType":"script"}