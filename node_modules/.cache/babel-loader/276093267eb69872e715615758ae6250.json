{"ast":null,"code":"/**\n* Copyright 2012-2019, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar d3 = require('d3');\n\nvar Registry = require('../../registry');\n\nvar Plots = require('../../plots/plots');\n\nvar Color = require('../color');\n\nvar Drawing = require('../drawing');\n\nvar Lib = require('../../lib');\n\nvar svgTextUtils = require('../../lib/svg_text_utils');\n\nvar axisIds = require('../../plots/cartesian/axis_ids');\n\nvar alignmentConstants = require('../../constants/alignment');\n\nvar LINE_SPACING = alignmentConstants.LINE_SPACING;\nvar FROM_TL = alignmentConstants.FROM_TL;\nvar FROM_BR = alignmentConstants.FROM_BR;\n\nvar constants = require('./constants');\n\nvar getUpdateObject = require('./get_update_object');\n\nmodule.exports = function draw(gd) {\n  var fullLayout = gd._fullLayout;\n\n  var selectors = fullLayout._infolayer.selectAll('.rangeselector').data(makeSelectorData(gd), selectorKeyFunc);\n\n  selectors.enter().append('g').classed('rangeselector', true);\n  selectors.exit().remove();\n  selectors.style({\n    cursor: 'pointer',\n    'pointer-events': 'all'\n  });\n  selectors.each(function (d) {\n    var selector = d3.select(this);\n    var axisLayout = d;\n    var selectorLayout = axisLayout.rangeselector;\n    var buttons = selector.selectAll('g.button').data(Lib.filterVisible(selectorLayout.buttons));\n    buttons.enter().append('g').classed('button', true);\n    buttons.exit().remove();\n    buttons.each(function (d) {\n      var button = d3.select(this);\n      var update = getUpdateObject(axisLayout, d);\n      d._isActive = isActive(axisLayout, d, update);\n      button.call(drawButtonRect, selectorLayout, d);\n      button.call(drawButtonText, selectorLayout, d, gd);\n      button.on('click', function () {\n        if (gd._dragged) return;\n        Registry.call('_guiRelayout', gd, update);\n      });\n      button.on('mouseover', function () {\n        d._isHovered = true;\n        button.call(drawButtonRect, selectorLayout, d);\n      });\n      button.on('mouseout', function () {\n        d._isHovered = false;\n        button.call(drawButtonRect, selectorLayout, d);\n      });\n    });\n    reposition(gd, buttons, selectorLayout, axisLayout._name, selector);\n  });\n};\n\nfunction makeSelectorData(gd) {\n  var axes = axisIds.list(gd, 'x', true);\n  var data = [];\n\n  for (var i = 0; i < axes.length; i++) {\n    var axis = axes[i];\n\n    if (axis.rangeselector && axis.rangeselector.visible) {\n      data.push(axis);\n    }\n  }\n\n  return data;\n}\n\nfunction selectorKeyFunc(d) {\n  return d._id;\n}\n\nfunction isActive(axisLayout, opts, update) {\n  if (opts.step === 'all') {\n    return axisLayout.autorange === true;\n  } else {\n    var keys = Object.keys(update);\n    return axisLayout.range[0] === update[keys[0]] && axisLayout.range[1] === update[keys[1]];\n  }\n}\n\nfunction drawButtonRect(button, selectorLayout, d) {\n  var rect = Lib.ensureSingle(button, 'rect', 'selector-rect', function (s) {\n    s.attr('shape-rendering', 'crispEdges');\n  });\n  rect.attr({\n    'rx': constants.rx,\n    'ry': constants.ry\n  });\n  rect.call(Color.stroke, selectorLayout.bordercolor).call(Color.fill, getFillColor(selectorLayout, d)).style('stroke-width', selectorLayout.borderwidth + 'px');\n}\n\nfunction getFillColor(selectorLayout, d) {\n  return d._isActive || d._isHovered ? selectorLayout.activecolor : selectorLayout.bgcolor;\n}\n\nfunction drawButtonText(button, selectorLayout, d, gd) {\n  function textLayout(s) {\n    svgTextUtils.convertToTspans(s, gd);\n  }\n\n  var text = Lib.ensureSingle(button, 'text', 'selector-text', function (s) {\n    s.classed('user-select-none', true).attr('text-anchor', 'middle');\n  });\n  text.call(Drawing.font, selectorLayout.font).text(getLabel(d, gd._fullLayout._meta)).call(textLayout);\n}\n\nfunction getLabel(opts, _meta) {\n  if (opts.label) {\n    return _meta ? Lib.templateString(opts.label, _meta) : opts.label;\n  }\n\n  if (opts.step === 'all') return 'all';\n  return opts.count + opts.step.charAt(0);\n}\n\nfunction reposition(gd, buttons, opts, axName, selector) {\n  var width = 0;\n  var height = 0;\n  var borderWidth = opts.borderwidth;\n  buttons.each(function () {\n    var button = d3.select(this);\n    var text = button.select('.selector-text');\n    var tHeight = opts.font.size * LINE_SPACING;\n    var hEff = Math.max(tHeight * svgTextUtils.lineCount(text), 16) + 3;\n    height = Math.max(height, hEff);\n  });\n  buttons.each(function () {\n    var button = d3.select(this);\n    var rect = button.select('.selector-rect');\n    var text = button.select('.selector-text');\n    var tWidth = text.node() && Drawing.bBox(text.node()).width;\n    var tHeight = opts.font.size * LINE_SPACING;\n    var tLines = svgTextUtils.lineCount(text);\n    var wEff = Math.max(tWidth + 10, constants.minButtonWidth); // TODO add MathJax support\n    // TODO add buttongap attribute\n\n    button.attr('transform', 'translate(' + (borderWidth + width) + ',' + borderWidth + ')');\n    rect.attr({\n      x: 0,\n      y: 0,\n      width: wEff,\n      height: height\n    });\n    svgTextUtils.positionText(text, wEff / 2, height / 2 - (tLines - 1) * tHeight / 2 + 3);\n    width += wEff + 5;\n  });\n  var graphSize = gd._fullLayout._size;\n  var lx = graphSize.l + graphSize.w * opts.x;\n  var ly = graphSize.t + graphSize.h * (1 - opts.y);\n  var xanchor = 'left';\n\n  if (Lib.isRightAnchor(opts)) {\n    lx -= width;\n    xanchor = 'right';\n  }\n\n  if (Lib.isCenterAnchor(opts)) {\n    lx -= width / 2;\n    xanchor = 'center';\n  }\n\n  var yanchor = 'top';\n\n  if (Lib.isBottomAnchor(opts)) {\n    ly -= height;\n    yanchor = 'bottom';\n  }\n\n  if (Lib.isMiddleAnchor(opts)) {\n    ly -= height / 2;\n    yanchor = 'middle';\n  }\n\n  width = Math.ceil(width);\n  height = Math.ceil(height);\n  lx = Math.round(lx);\n  ly = Math.round(ly);\n  Plots.autoMargin(gd, axName + '-range-selector', {\n    x: opts.x,\n    y: opts.y,\n    l: width * FROM_TL[xanchor],\n    r: width * FROM_BR[xanchor],\n    b: height * FROM_BR[yanchor],\n    t: height * FROM_TL[yanchor]\n  });\n  selector.attr('transform', 'translate(' + lx + ',' + ly + ')');\n}","map":null,"metadata":{},"sourceType":"script"}