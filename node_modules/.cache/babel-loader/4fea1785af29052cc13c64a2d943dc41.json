{"ast":null,"code":"/**\n* Copyright 2012-2019, Plotly, Inc.\n* All rights reserved.\n*\n* This source code is licensed under the MIT license found in the\n* LICENSE file in the root directory of this source tree.\n*/\n'use strict';\n\nvar Lib = require('../../lib');\n\nvar Registry = require('../../registry');\n\nvar arrayEditor = require('../../plot_api/plot_template').arrayEditor;\n\nmodule.exports = {\n  hasClickToShow: hasClickToShow,\n  onClick: onClick\n};\n/*\n * hasClickToShow: does the given hoverData have ANY annotations which will\n * turn ON if we click here? (used by hover events to set cursor)\n *\n * gd: graphDiv\n * hoverData: a hoverData array, as included with the *plotly_hover* or\n *     *plotly_click* events in the `points` attribute\n *\n * returns: boolean\n */\n\nfunction hasClickToShow(gd, hoverData) {\n  var sets = getToggleSets(gd, hoverData);\n  return sets.on.length > 0 || sets.explicitOff.length > 0;\n}\n/*\n * onClick: perform the toggling (via Plotly.update) implied by clicking\n * at this hoverData\n *\n * gd: graphDiv\n * hoverData: a hoverData array, as included with the *plotly_hover* or\n *     *plotly_click* events in the `points` attribute\n *\n * returns: Promise that the update is complete\n */\n\n\nfunction onClick(gd, hoverData) {\n  var toggleSets = getToggleSets(gd, hoverData);\n  var onSet = toggleSets.on;\n  var offSet = toggleSets.off.concat(toggleSets.explicitOff);\n  var update = {};\n  var annotationsOut = gd._fullLayout.annotations;\n  var i, editHelpers;\n  if (!(onSet.length || offSet.length)) return;\n\n  for (i = 0; i < onSet.length; i++) {\n    editHelpers = arrayEditor(gd.layout, 'annotations', annotationsOut[onSet[i]]);\n    editHelpers.modifyItem('visible', true);\n    Lib.extendFlat(update, editHelpers.getUpdateObj());\n  }\n\n  for (i = 0; i < offSet.length; i++) {\n    editHelpers = arrayEditor(gd.layout, 'annotations', annotationsOut[offSet[i]]);\n    editHelpers.modifyItem('visible', false);\n    Lib.extendFlat(update, editHelpers.getUpdateObj());\n  }\n\n  return Registry.call('update', gd, {}, update);\n}\n/*\n * getToggleSets: find the annotations which will turn on or off at this\n * hoverData\n *\n * gd: graphDiv\n * hoverData: a hoverData array, as included with the *plotly_hover* or\n *     *plotly_click* events in the `points` attribute\n *\n * returns: {\n *   on: Array (indices of annotations to turn on),\n *   off: Array (indices to turn off because you're not hovering on them),\n *   explicitOff: Array (indices to turn off because you *are* hovering on them)\n * }\n */\n\n\nfunction getToggleSets(gd, hoverData) {\n  var annotations = gd._fullLayout.annotations;\n  var onSet = [];\n  var offSet = [];\n  var explicitOffSet = [];\n  var hoverLen = (hoverData || []).length;\n  var i, j, anni, showMode, pointj, xa, ya, toggleType;\n\n  for (i = 0; i < annotations.length; i++) {\n    anni = annotations[i];\n    showMode = anni.clicktoshow;\n\n    if (showMode) {\n      for (j = 0; j < hoverLen; j++) {\n        pointj = hoverData[j];\n        xa = pointj.xaxis;\n        ya = pointj.yaxis;\n\n        if (xa._id === anni.xref && ya._id === anni.yref && xa.d2r(pointj.x) === clickData2r(anni._xclick, xa) && ya.d2r(pointj.y) === clickData2r(anni._yclick, ya)) {\n          // match! toggle this annotation\n          // regardless of its clicktoshow mode\n          // but if it's onout mode, off is implicit\n          if (anni.visible) {\n            if (showMode === 'onout') toggleType = offSet;else toggleType = explicitOffSet;\n          } else {\n            toggleType = onSet;\n          }\n\n          toggleType.push(i);\n          break;\n        }\n      }\n\n      if (j === hoverLen) {\n        // no match - only turn this annotation OFF, and only if\n        // showmode is 'onout'\n        if (anni.visible && showMode === 'onout') offSet.push(i);\n      }\n    }\n  }\n\n  return {\n    on: onSet,\n    off: offSet,\n    explicitOff: explicitOffSet\n  };\n} // to handle log axes until v2\n\n\nfunction clickData2r(d, ax) {\n  return ax.type === 'log' ? ax.l2r(d) : ax.d2r(d);\n}","map":null,"metadata":{},"sourceType":"script"}